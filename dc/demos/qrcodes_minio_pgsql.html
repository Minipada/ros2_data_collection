<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>QRcodes to PostgreSQL/MinIO - Data Collection for ROS 2</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/lineicon.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../open-in.css">
        <link rel="stylesheet" href="../.././css/mdbook-admonish.css">
        <link rel="stylesheet" href="../../css/logo.css">
        <link rel="stylesheet" href="../../css/lineicon.css">
        <link rel="stylesheet" href="../../css/theme.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Hotjar -->
        <script>
            if (window.location.href.startsWith("https://minipada.github.io/ros2_data_collection")) {
            (function(h,o,t,j,a,r){
                h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
                h._hjSettings={hjid:3435761,hjsv:6};
                a=o.getElementsByTagName('head')[0];
                r=o.createElement('script');r.async=1;
                r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
                a.appendChild(r);
            })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
            }
        </script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <a href="/"><img id="logo-dc"></a>
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../dc/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item "><a href="../../dc/setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li class="chapter-item "><a href="../../dc/concepts.html"><strong aria-hidden="true">3.</strong> Concepts</a></li><li class="chapter-item "><a href="../../dc/data_pipeline.html"><strong aria-hidden="true">4.</strong> Data Pipeline</a></li><li class="chapter-item "><a href="../../dc/measurements.html"><strong aria-hidden="true">5.</strong> Measurements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dc/measurements/camera.html"><strong aria-hidden="true">5.1.</strong> Camera</a></li><li class="chapter-item "><a href="../../dc/measurements/cmd_vel.html"><strong aria-hidden="true">5.2.</strong> Command velocity</a></li><li class="chapter-item "><a href="../../dc/measurements/cpu.html"><strong aria-hidden="true">5.3.</strong> CPU</a></li><li class="chapter-item "><a href="../../dc/measurements/distance_traveled.html"><strong aria-hidden="true">5.4.</strong> Distance traveled</a></li><li class="chapter-item "><a href="../../dc/measurements/ip_camera.html"><strong aria-hidden="true">5.5.</strong> IP Camera</a></li><li class="chapter-item "><a href="../../dc/measurements/map.html"><strong aria-hidden="true">5.6.</strong> Map</a></li><li class="chapter-item "><a href="../../dc/measurements/memory.html"><strong aria-hidden="true">5.7.</strong> Memory</a></li><li class="chapter-item "><a href="../../dc/measurements/network.html"><strong aria-hidden="true">5.8.</strong> Network</a></li><li class="chapter-item "><a href="../../dc/measurements/os.html"><strong aria-hidden="true">5.9.</strong> OS</a></li><li class="chapter-item "><a href="../../dc/measurements/permissions.html"><strong aria-hidden="true">5.10.</strong> Permissions</a></li><li class="chapter-item "><a href="../../dc/measurements/position.html"><strong aria-hidden="true">5.11.</strong> Position</a></li><li class="chapter-item "><a href="../../dc/measurements/speed.html"><strong aria-hidden="true">5.12.</strong> Speed</a></li><li class="chapter-item "><a href="../../dc/measurements/storage.html"><strong aria-hidden="true">5.13.</strong> Storage</a></li><li class="chapter-item "><a href="../../dc/measurements/string_stamped.html"><strong aria-hidden="true">5.14.</strong> String stamped</a></li><li class="chapter-item "><a href="../../dc/measurements/tcp_health.html"><strong aria-hidden="true">5.15.</strong> TCP Health</a></li><li class="chapter-item "><a href="../../dc/measurements/uptime.html"><strong aria-hidden="true">5.16.</strong> Uptime</a></li></ol></li><li class="chapter-item "><a href="../../dc/conditions.html"><strong aria-hidden="true">6.</strong> Conditions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dc/conditions/bool_equal.html"><strong aria-hidden="true">6.1.</strong> Bool equal</a></li><li class="chapter-item "><a href="../../dc/conditions/double_equal.html"><strong aria-hidden="true">6.2.</strong> Double equal</a></li><li class="chapter-item "><a href="../../dc/conditions/double_inferior.html"><strong aria-hidden="true">6.3.</strong> Double inferior</a></li><li class="chapter-item "><a href="../../dc/conditions/double_superior.html"><strong aria-hidden="true">6.4.</strong> Double superior</a></li><li class="chapter-item "><a href="../../dc/conditions/exist.html"><strong aria-hidden="true">6.5.</strong> Exist</a></li><li class="chapter-item "><a href="../../dc/conditions/integer_equal.html"><strong aria-hidden="true">6.6.</strong> Integer equal</a></li><li class="chapter-item "><a href="../../dc/conditions/integer_inferior.html"><strong aria-hidden="true">6.7.</strong> Integer inferior</a></li><li class="chapter-item "><a href="../../dc/conditions/integer_superior.html"><strong aria-hidden="true">6.8.</strong> Integer superior</a></li><li class="chapter-item "><a href="../../dc/conditions/list_bool_equal.html"><strong aria-hidden="true">6.9.</strong> List bool equal</a></li><li class="chapter-item "><a href="../../dc/conditions/list_double_equal.html"><strong aria-hidden="true">6.10.</strong> List double equal</a></li><li class="chapter-item "><a href="../../dc/conditions/list_integer_equal.html"><strong aria-hidden="true">6.11.</strong> List integer equal</a></li><li class="chapter-item "><a href="../../dc/conditions/list_string_equal.html"><strong aria-hidden="true">6.12.</strong> List string equal</a></li><li class="chapter-item "><a href="../../dc/conditions/moving.html"><strong aria-hidden="true">6.13.</strong> Moving</a></li><li class="chapter-item "><a href="../../dc/conditions/same_as_previous.html"><strong aria-hidden="true">6.14.</strong> Same as previous</a></li><li class="chapter-item "><a href="../../dc/conditions/string_match.html"><strong aria-hidden="true">6.15.</strong> String match</a></li></ol></li><li class="chapter-item "><a href="../../dc/data_validation.html"><strong aria-hidden="true">7.</strong> Data validation</a></li><li class="chapter-item "><a href="../../dc/groups.html"><strong aria-hidden="true">8.</strong> Groups</a></li><li class="chapter-item "><a href="../../dc/destinations.html"><strong aria-hidden="true">9.</strong> Destinations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dc/destinations/flb_kinesis_data_streams.html"><strong aria-hidden="true">9.1.</strong> Fluent Bit AWS Kinesis Data Streams</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_s3.html"><strong aria-hidden="true">9.2.</strong> Fluent Bit AWS S3</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_file.html"><strong aria-hidden="true">9.3.</strong> Fluent Bit File</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_files_metrics.html"><strong aria-hidden="true">9.4.</strong> Fluent Bit Files metrics</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_http.html"><strong aria-hidden="true">9.5.</strong> Fluent Bit HTTP</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_minio.html"><strong aria-hidden="true">9.6.</strong> Fluent Bit Minio</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_null.html"><strong aria-hidden="true">9.7.</strong> Fluent Bit NULL</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_pgsql.html"><strong aria-hidden="true">9.8.</strong> Fluent Bit PostgreSQL</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_slack.html"><strong aria-hidden="true">9.9.</strong> Fluent Bit Slack</a></li><li class="chapter-item "><a href="../../dc/destinations/flb_stdout.html"><strong aria-hidden="true">9.10.</strong> Fluent Bit Stdout</a></li><li class="chapter-item "><a href="../../dc/destinations/rcl.html"><strong aria-hidden="true">9.11.</strong> RCL</a></li></ol></li><li class="chapter-item "><a href="../../dc/configuration_examples.html"><strong aria-hidden="true">10.</strong> Configuration examples</a></li><li class="chapter-item expanded "><a href="../../dc/demos.html"><strong aria-hidden="true">11.</strong> Demos</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dc/demos/uptime_stdout.html"><strong aria-hidden="true">11.1.</strong> Uptime</a></li><li class="chapter-item "><a href="../../dc/demos/memory_uptime_stdout.html"><strong aria-hidden="true">11.2.</strong> Group memory and uptime</a></li><li class="chapter-item "><a href="../../dc/demos/tb3_stdout.html"><strong aria-hidden="true">11.3.</strong> Turtlebot3</a></li><li class="chapter-item "><a href="../../dc/demos/tb3_aws_minio_pgsql.html"><strong aria-hidden="true">11.4.</strong> Turtlebot3 AWS Warehouse MinIO PostgreSQL</a></li><li class="chapter-item expanded "><a href="../../dc/demos/qrcodes_minio_pgsql.html" class="active"><strong aria-hidden="true">11.5.</strong> QRcodes to PostgreSQL/MinIO</a></li><li class="chapter-item "><a href="../../dc/demos/custom_stdout.html"><strong aria-hidden="true">11.6.</strong> Custom plugin</a></li></ol></li><li class="chapter-item "><a href="../../dc/infrastructure_setup.html"><strong aria-hidden="true">12.</strong> Infrastructure setup</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dc/infrastructure_setup/minio.html"><strong aria-hidden="true">12.1.</strong> MinIO</a></li><li class="chapter-item "><a href="../../dc/infrastructure_setup/postgresql.html"><strong aria-hidden="true">12.2.</strong> PostgreSQL</a></li><li class="chapter-item "><a href="../../dc/infrastructure_setup/ip_camera.html"><strong aria-hidden="true">12.3.</strong> Ip camera</a></li></ol></li><li class="chapter-item "><a href="../../dc/cli.html"><strong aria-hidden="true">13.</strong> CLI tools</a></li><li class="chapter-item "><a href="../../dc/future_work.html"><strong aria-hidden="true">14.</strong> Future work and Roadmap</a></li><li class="chapter-item "><a href="../../dc/contributing.html"><strong aria-hidden="true">15.</strong> Contributing</a></li><li class="chapter-item "><a href="../../dc/faq.html"><strong aria-hidden="true">16.</strong> FAQ</a></li><li class="chapter-item "><a href="../../dc/about_contact.html"><strong aria-hidden="true">17.</strong> About and Contact</a></li></ol>
                <footer id="nav-separator"></footer>
                <a style="margin-right: 10px;" href="https://github.com/minipada/ros2_data_collection" target="_blank"><i  class="lni lni-github-original lni-32"></i></a>
                <a style="margin-right: 10px;" href="mailto:d.bensoussan@proton.me" target="_blank"><i  class="lni lni-envelope lni-32"></i></a>
                <div>Under <a target="_blank" style="color: var(--sidebar-active);"
                    href="https://tldrlegal.com/license/mozilla-public-license-2.0-(mpl-2)">MPL-2.0</a>
                license</a>
                </div>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Data Collection for ROS 2</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/minipada/ros2_data_collection" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/minipada/ros2_data_collection/edit/humble/doc/src/dc/demos/qrcodes_minio_pgsql.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="qrcodes"><a class="header" href="#qrcodes">QRCodes</a></h1>
<p>In this example, we add a robot and start collecting robot data to PostgreSQL and maps and scanned QRcodes to MinIO as image files.</p>
<p>You will also need 2 terminal windows, to:</p>
<ol>
<li>Run the Nav2 turtlebot3 launchfile: it starts localization, navigation and RViz</li>
<li>Run DC</li>
</ol>
<p>Since RViz is pretty verbose, using 3 terminal windows will help reading the JSON printed on the terminal window.</p>
<div class="table-wrapper"><table><thead><tr><th>Terminal</th><th>Description</th></tr></thead><tbody>
<tr><td>RViz</td><td>Start it independently because of its verbosity</td></tr>
<tr><td>Nav2</td><td>Localization and navigation</td></tr>
<tr><td>DC</td><td>Data collection</td></tr>
</tbody></table>
</div>
<h2 id="setup-minio-and-postgresql"><a class="header" href="#setup-minio-and-postgresql">Setup MinIO and PostgreSQL</a></h2>
<h3 id="minio"><a class="header" href="#minio">MinIO</a></h3>
<p>MinIO will be used as storage for images and other files. To start it, <a href="../infrastructure_setup/minio.html">follow the steps</a></p>
<h3 id="postgresql"><a class="header" href="#postgresql">PostgreSQL</a></h3>
<p>PostgreSQL will be used as database storage for our JSON. Later on, backend engineers can make requests on those JSON based on measurement requested and time range. To start it, <a href="../infrastructure_setup/postgresql.html">follow the steps</a></p>
<h2 id="setup-the-ros-environment"><a class="header" href="#setup-the-ros-environment">Setup the ROS environment</a></h2>
<p>In each, terminal, source your environment and setup turtlebot configuration:</p>
<pre><code class="language-bash">$ source /opt/ros/humble/setup.bash
$ source install/setup.bash
$ export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:/opt/ros/humble/share/turtlebot3_gazebo/models
$ export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:/opt/ros/humble/share/aws_robomaker_small_warehouse_world/models/
$ export TURTLEBOT3_MODEL=waffle
</code></pre>
<h2 id="start-rviz"><a class="header" href="#start-rviz">Start RVIZ</a></h2>
<pre><code class="language-bash">$ ros2 run rviz2 rviz2 -d ${PWD}/install/dc_simulation/share/dc_simulation/rviz/qrcodes.rviz
</code></pre>
<h2 id="start-navigation"><a class="header" href="#start-navigation">Start Navigation</a></h2>
<p>Then, start the Turtlebot launchfile with custom parameters to start the QRcode world:</p>
<pre><code class="language-bash">$ ros2 launch nav2_bringup tb3_simulation_launch.py \
    headless:=False \
    x_pose:=&quot;-16.679400&quot; \
    y_pose:=&quot;-15.300200&quot; \
    z_pose:=&quot;0.01&quot; \
    roll:=&quot;0.00&quot; \
    pitch:=&quot;0.00&quot; \
    yaw:=&quot;1.570796&quot; \
    robot_sdf:=&quot;${PWD}/install/dc_simulation/share/dc_simulation/worlds/waffle.model&quot; \
    map:=&quot;${PWD}/install/dc_simulation/share/dc_simulation/maps/qrcodes.yaml&quot; \
    world:=&quot;${PWD}/install/dc_simulation/share/dc_simulation/worlds/qrcodes.world&quot; \
    nav2_params_file:=&quot;${PWD}/install/dc_simulation/share/dc_demos/params/qrcodes_nav.yaml&quot; \
    dc_params_file:=&quot;${PWD}/install/dc_simulation/share/dc_demos/params/qrcodes_minio_pgsql.yaml&quot; \
    rviz_config_file:=&quot;${PWD}/install/dc_simulation/share/dc_simulation/rviz/qrcodes.rviz&quot; \
    use_rviz:=False
</code></pre>
<p>RViz and Gazebo will start: you should now see the robot in Gazebo, and the map on RViz.</p>
<p>Set the robot position using the &quot;2D Pose Estimate&quot; button.</p>
<h2 id="start-dc"><a class="header" href="#start-dc">Start DC</a></h2>
<p>Execute</p>
<pre><code class="language-bash">$ ros2 launch dc_demos tb3_qrcodes_minio_pgsql.launch.py
</code></pre>
<p>With this, all data will be transmitted</p>
<h2 id="understanding-the-configuration"><a class="header" href="#understanding-the-configuration">Understanding the configuration</a></h2>
<div id="admonition-info" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="#admonition-info"></a></p>
</div>
<div>
<p>The full configuration file can be found <a href="https://github.com/Minipada/ros2_data_collection/blob/humble/dc_demos/params/qrcodes_minio_pgsql.yaml">here</a>.</p>
</div>
</div>
<p>For this demo, we will reconstruct the yaml configuration element by element, given how large it is. Go through the explanation to understand how it works.</p>
<h3 id="collect-command-velocity-position-and-speed-to-postgresql-as-a-group"><a class="header" href="#collect-command-velocity-position-and-speed-to-postgresql-as-a-group">Collect command velocity, position and speed to PostgreSQL as a group</a></h3>
<p>Similarly to the previous tutorial:</p>
<pre><code class="language-yaml">destination_server:
  ros__parameters:
    flb:
      flush: 1
      flb_grace: 1
      log_level: &quot;info&quot;
      storage_path: &quot;/var/log/flb-storage/&quot;
      storage_sync: &quot;full&quot;
      storage_checksum: &quot;off&quot;
      storage_backlog_mem_limit: &quot;1M&quot;
      scheduler_cap: 200
      scheduler_base: 5
      http_server: true
      http_listen: &quot;0.0.0.0&quot;
      http_port: 2020
      in_storage_type: &quot;filesystem&quot;
      in_storage_pause_on_chunks_overlimit: &quot;off&quot;
    destination_plugins: [&quot;flb_pgsql&quot;]
    custom_str_params_list: [&quot;robot_name&quot;, &quot;id&quot;]
    custom_str_params:
      robot_name:
        name: robot_name
        value: &quot;C3PO&quot;
      # Requires systemd package
      id:
        name: id
        value_from_file: /etc/machine-id
    run_id:
      enabled: true
      counter: true
      counter_path: &quot;$HOME/run_id&quot;
      uuid: false
    flb_pgsql:
      plugin: &quot;dc_destinations/FlbPgSQL&quot;
      inputs: [&quot;/dc/group/robot&quot;]
      host: &quot;127.0.0.1&quot;
      port: 5432
      user: fluentbit
      password: password
      database: &quot;fluentbit&quot;
      table: &quot;dc&quot;
      timestamp_key: &quot;date&quot;
      async: false
      time_format: &quot;double&quot;
      time_key: &quot;date&quot;

group_server:
  ros__parameters:
    groups: [&quot;robot&quot;]
    robot:
      inputs:
        [
          &quot;/dc/measurement/cmd_vel&quot;,
          &quot;/dc/measurement/position&quot;,
          &quot;/dc/measurement/speed&quot;,
        ]
      output: &quot;/dc/group/robot&quot;
      sync_delay: 5.0
      group_key: &quot;robot&quot;
      tags: [&quot;flb_pgsql&quot;]

measurement_server:
  ros__parameters:
    custom_str_params: [&quot;robot_name&quot;]
    robot_name: &quot;C3PO&quot;
    measurement_plugins: [&quot;cmd_vel&quot;, &quot;position&quot;, &quot;speed&quot;]
    moving:
      plugin: &quot;dc_conditions/Moving&quot;
    cmd_vel:
      plugin: &quot;dc_measurements/CmdVel&quot;
      group_key: &quot;cmd_vel&quot;
      enable_validator: true
      topic_output: &quot;/dc/measurement/cmd_vel&quot;
      include_measurement_name: true
    position:
      plugin: &quot;dc_measurements/Position&quot;
      group_key: &quot;position&quot;
      topic_output: &quot;/dc/measurement/position&quot;
      enable_validator: true
      global_frame: &quot;map&quot;
      robot_base_frame: &quot;base_link&quot;
      transform_timeout: 0.1
      include_measurement_name: true
    speed:
      plugin: &quot;dc_measurements/Speed&quot;
      group_key: &quot;speed&quot;
      odom_topic: &quot;/odom&quot;
      topic_output: &quot;/dc/measurement/speed&quot;
      include_measurement_name: true
</code></pre>
<p>In the measurement server, we set 3 measurements: cmd_vel, position and speed being collected once per second, are validated with their respective JSON schemas and publish on their own topics.</p>
<p>Note the <code>include_measurement_name</code> which include measurement name in the JSON, which is used when grouping. The group collects the data from those 3 measurement and republishes it on the group topic <code>/dc/group/robot</code>.</p>
<p>In the destination server, we enable the PostgreSQL plugin and configure its credentials.</p>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="#admonition-warning"></a></p>
</div>
<div>
<p>Be sure to change the login and password to your current infrastructure configuration. Do it in production setup!</p>
</div>
</div>
<p>You can find more about the PostgreSQL plugin <a href="../destinations/flb_files_metrics.html">here</a></p>
<p>To take a look at records, go to Adminer. It is by default started at <a href="http://localhost:8080">http://localhost:8080</a>, it is a database GUI.:</p>
<p><img src="../../images/qrcodes_pgsql_adminer.png" alt="Adminer" /></p>
<p>You can then click on a record, to take a look, edit or delete it:</p>
<p><img src="../../images/qrcodes_pgsql_adminer_record.png" alt="Adminer" /></p>
<h3 id="send-the-map-image-and-yaml-from-nav2_map_server-to-minio"><a class="header" href="#send-the-map-image-and-yaml-from-nav2_map_server-to-minio">Send the map image and YAML from nav2_map_server to MinIO</a></h3>
<p>First, we add the map measurement. We use 3 plugins here: flb_pgsql to send the data to PostgreSQL on the dc database, then flb_minio to send some files to MinIO and flb_files_metrics which will be used to autodelete the files once they reach their destination.</p>
<pre><code class="language-yaml">measurement_server:
  ros__parameters:
  ...
  measurement_plugins: [&quot;map&quot;]
  map:
    plugin: &quot;dc_measurements/Map&quot;
    group_key: &quot;map&quot;
    polling_interval: 5000
    save_path: &quot;map/%Y-%m-%dT%H:%M:%S&quot;
    topic_output: &quot;/dc/measurement/map&quot;
    save_map_timeout: 4.0
    remote_prefixes: [&quot;&quot;]
    remote_keys: [&quot;minio&quot;]
    enable_validator: true
    tags: [&quot;flb_pgsql&quot;, &quot;flb_minio&quot;, &quot;flb_files_metrics&quot;]
    include_measurement_name: true
  ...
</code></pre>
<p>Then we add the destinations:</p>
<pre><code class="language-yaml">destination_server:
  ros__parameters:
    ...
    destination_plugins: [&quot;flb_files_metrics&quot;, &quot;flb_pgsql&quot;, &quot;flb_minio&quot;]
    flb_files_metrics:
      plugin: &quot;dc_destinations/FlbFilesMetrics&quot;
      inputs: [&quot;/dc/measurement/map&quot;]
      file_storage: [&quot;minio&quot;]
      db_type: &quot;pgsql&quot;
      delete_when_sent: true
      minio:
        endpoint: 127.0.0.1:9000
        access_key_id: rQXPf1f730Yuu2yW # Change it
        secret_access_key: TYYkjN5L4gqDgCGLzQahHDcvqL4WNTcb # Change it
        use_ssl: false
        bucket: &quot;mybucket&quot;
        src_fields: [&quot;local_paths.pgm&quot;, &quot;local_paths.yaml&quot;]
        upload_fields: [&quot;remote_paths.minio.pgm&quot;, &quot;remote_paths.minio.yaml&quot;]
        input_names: [&quot;map&quot;, &quot;map&quot;]
      pgsql:
        host: &quot;127.0.0.1&quot;
        port: &quot;5432&quot;
        user: fluentbit # Change it
        password: password # Change it
        database: &quot;fluentbit&quot;
        table: &quot;files_metrics&quot;
        timestamp_key: &quot;date&quot;
        time_format: &quot;double&quot;
        time_key: &quot;date&quot;
        ssl: false
    flb_minio:
      verbose_plugin: false
      time_format: &quot;iso8601&quot;
      plugin: &quot;dc_destinations/FlbMinIO&quot;
      inputs: [&quot;/dc/measurement/map&quot;]
      endpoint: 127.0.0.1:9000
      access_key_id: rQXPf1f730Yuu2yW # Change it
      secret_access_key: TYYkjN5L4gqDgCGLzQahHDcvqL4WNTcb # Change it
      use_ssl: false
      create_bucket: true
      bucket: &quot;mybucket&quot; # Change it
      src_fields: [&quot;local_paths.pgm&quot;, &quot;local_paths.yaml&quot;]
      upload_fields: [&quot;remote_paths.minio.pgm&quot;, &quot;remote_paths.minio.yaml&quot;]
    flb_pgsql:
      plugin: &quot;dc_destinations/FlbPgSQL&quot;
      inputs: [&quot;/dc/group/map&quot;]
      host: &quot;127.0.0.1&quot;
      port: 5432
      user: fluentbit
      password: password
      database: &quot;fluentbit&quot;
      table: &quot;dc&quot;
      timestamp_key: &quot;date&quot;
      async: false
      time_format: &quot;double&quot;
      time_key: &quot;date&quot;
</code></pre>
<p>This will save the map pgm and yaml every 5 seconds to MinIO. Head to the MinIO GUI, which is by default located at <a href="http://localhost:9001">http://localhost:9001</a>. Default user/password are <strong>minioadmin</strong>/<strong>minioadmin</strong>.</p>
<p><img src="../../images/qrcodes_map_minio.png" alt="MapMinIO" /></p>
<p>It will also save the map metadata on PostgreSQL, which you can later use to know the map location on MinIO and its dimensions for example:</p>
<p><img src="../../images/qrcodes_map_pgsql.png" alt="MapPostgreSQL" /></p>
<p>We also transmit the metadata, to be fetched later on by the backend (map dimension and path). It is set in the flb_pgsql measurement plugin.</p>
<p>The flb_metrics plugin is also enabled. We use it to track if the file is on the filesystem and also delete it once it reaches its destination, here MinIO. This plugins deletes file when they are sent with the <code>delete_when_sent</code> parameter. More about the plugin <a href="../destinations/flb_files_metrics.html">here</a></p>
<p>Then, similarly, on Adminer, you can check the data is uploaded and deleted:</p>
<p><img src="../../images/qrcodes_pgsql_adminer_files_metrics.png" alt="MapAdminerFilesMetrics" /></p>
<h3 id="send-qr-code-images-to-minio"><a class="header" href="#send-qr-code-images-to-minio">Send QR code images to MinIO</a></h3>
<p>We want to collect pictures taken by the cameras</p>
<pre><code class="language-yaml">measurement_server:
  ros__parameters:
  ...
  measurement_plugins: [&quot;right_camera&quot;, &quot;left_camera&quot;]
  condition_plugins: [&quot;moving&quot;, &quot;inspected_exists&quot;]
  destinations:
    minio:
      bucket: mybucket
  moving:
    plugin: &quot;dc_conditions/Moving&quot;
  inspected_exists:
    plugin: &quot;dc_conditions/Exist&quot;
    key: &quot;inspected&quot;
  right_camera:
    plugin: &quot;dc_measurements/Camera&quot;
    group_key: &quot;right_camera&quot;
    if_none_conditions: [&quot;moving&quot;]
    if_all_conditions: [&quot;inspected_exists&quot;]
    topic_output: &quot;/dc/measurement/right_camera&quot;
    init_collect: false
    init_max_measurements: -1
    condition_max_measurements: 1
    node_name: &quot;dc_measurement_camera&quot;
    cam_topic: &quot;/right_intel_realsense_r200_depth/image_raw&quot;
    cam_name: right_camera
    enable_validator: true
    draw_det_barcodes: true
    save_raw_img: false
    save_rotated_img: false
    save_detections_img: true
    save_inspected_path: &quot;right_camera/inspected/%Y-%m-%dT%H-%M-%S&quot;
    rotation_angle: 0
    detection_modules: [&quot;barcode&quot;]
    remote_prefixes: [&quot;&quot;]
    remote_keys: [&quot;minio&quot;]
    tags: [&quot;flb_pgsql&quot;, &quot;flb_minio&quot;, &quot;flb_files_metrics&quot;]
    include_measurement_name: true
  left_camera:
    plugin: &quot;dc_measurements/Camera&quot;
    group_key: &quot;left_camera&quot;
    if_none_conditions: [&quot;moving&quot;]
    if_all_conditions: [&quot;inspected_exists&quot;]
    topic_output: &quot;/dc/measurement/left_camera&quot;
    init_collect: true
    init_max_measurements: -1
    condition_max_measurements: 1
    node_name: &quot;dc_measurement_camera&quot;
    cam_topic: &quot;/left_intel_realsense_r200_depth/image_raw&quot;
    cam_name: left_camera
    enable_validator: true
    draw_det_barcodes: true
    save_raw_img: false
    save_rotated_img: false
    save_detections_img: true
    save_inspected_path: &quot;left_camera/inspected/%Y-%m-%dT%H-%M-%S&quot;
    rotation_angle: 0
    detection_modules: [&quot;barcode&quot;]
    remote_prefixes: [&quot;&quot;]
    remote_keys: [&quot;minio&quot;]
    tags: [&quot;flb_pgsql&quot;, &quot;flb_minio&quot;, &quot;flb_files_metrics&quot;]
    include_measurement_name: true
  ...
</code></pre>
<p>Taking a look at the cameras, we can understand that:</p>
<ol>
<li>Data is only collected when the robot is not moving: <code>if_none_conditions: [&quot;moving&quot;]</code></li>
<li>Data is only collected when there is inspected data, so only when a QR code is detected: <code>if_all_conditions: [&quot;inspected_exists&quot;]</code></li>
<li>Data is not collected constantly: <code>init_max_measurements: -1</code></li>
<li>Only one record is collected when conditions are triggered: <code>condition_max_measurements: 1</code></li>
<li>Only images with inspected data are collected:
<ol>
<li><code>save_raw_img: false</code></li>
<li><code>save_rotated_img: false</code></li>
<li><code>save_detections_img: true</code></li>
</ol>
</li>
<li>Barcodes are scanned in each image: <code>detection_modules: [&quot;barcode&quot;]</code></li>
</ol>
<p>For the files-metrics, it is very important to have <code>include_measurement_name</code> since it relies on it to know in which field needs the paths are.</p>
<p>Then we add the destination:</p>
<pre><code class="language-yaml">destination_server:
  ros__parameters:
  ...
    destination_plugins: [&quot;flb_minio&quot;, &quot;flb_pgsql&quot;, &quot;flb_files_metrics&quot;]
    custom_str_params_list: [&quot;robot_name&quot;, &quot;id&quot;]
    custom_str_params:
      robot_name:
        name: robot_name
        value: &quot;C3PO&quot;
      # Requires systemd package
      id:
        name: id
        value_from_file: /etc/machine-id
    run_id:
      enabled: true
      counter: true
      counter_path: &quot;$HOME/run_id&quot;
      uuid: false
    flb_files_metrics:
      plugin: &quot;dc_destinations/FlbFilesMetrics&quot;
      inputs:
        [
          &quot;/dc/measurement/right_camera&quot;,
          &quot;/dc/measurement/left_camera&quot;,
        ]
      file_storage: [&quot;minio&quot;]
      db_type: &quot;pgsql&quot;
      delete_when_sent: true
      minio:
        endpoint: 127.0.0.1:9000
        access_key_id: rQXPf1f730Yuu2yW
        secret_access_key: TYYkjN5L4gqDgCGLzQahHDcvqL4WNTcb
        use_ssl: false
        bucket: &quot;mybucket&quot;
        src_fields:
          [
            &quot;local_paths.inspected&quot;,
            &quot;local_paths.inspected&quot;
          ]
        upload_fields:
          [
            &quot;remote_paths.minio.inspected&quot;,
            &quot;remote_paths.minio.inspected&quot;
          ]
      pgsql:
        host: &quot;127.0.0.1&quot;
        port: &quot;5432&quot;
        user: fluentbit
        password: password
        database: &quot;fluentbit&quot;
        table: &quot;files_metrics&quot;
        timestamp_key: &quot;date&quot;
        time_format: &quot;double&quot;
        time_key: &quot;date&quot;
        ssl: false
    flb_minio:
      verbose_plugin: false
      time_format: &quot;iso8601&quot;
      plugin: &quot;dc_destinations/FlbMinIO&quot;
      inputs: [&quot;/dc/measurement/right_camera&quot;, &quot;/dc/measurement/left_camera&quot;]
      endpoint: 127.0.0.1:9000
      access_key_id: rQXPf1f730Yuu2yW
      secret_access_key: TYYkjN5L4gqDgCGLzQahHDcvqL4WNTcb
      use_ssl: false
      bucket: &quot;mybucket&quot;
      src_fields:
        [
          &quot;local_paths.inspected&quot;,
          &quot;local_paths.inspected&quot;
        ]
      upload_fields:
        [
          &quot;remote_paths.minio.inspected&quot;,
          &quot;remote_paths.minio.inspected&quot;
        ]
    flb_pgsql:
      plugin: &quot;dc_destinations/FlbPgSQL&quot;
      inputs:
        [
          &quot;/dc/measurement/right_camera&quot;,
          &quot;/dc/measurement/left_camera&quot;,
        ]
      host: &quot;127.0.0.1&quot;
      port: 5432
      user: fluentbit
      password: password
      database: &quot;fluentbit&quot;
      table: &quot;dc&quot;
      timestamp_key: &quot;date&quot;
      async: false
      time_format: &quot;double&quot;
      time_key: &quot;date&quot;
</code></pre>
<p>Here, we collect images with the MinIO plugin, also send metadata to PostreSQL.</p>
<p>In addition, flb_files_metrics tracks when the files are sent to MinIO and deletes them when it is done. Note that multiple destinations can be configured for each field. Check the plugin documentation to see which remote destinations are supported.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/minipada/ros2_data_collection/edit/main/doc/src/dc/demos/qrcodes_minio_pgsql.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../dc/demos/tb3_aws_minio_pgsql.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../dc/demos/custom_stdout.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../dc/demos/tb3_aws_minio_pgsql.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../dc/demos/custom_stdout.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../js/mermaid.js"></script>
        <script src="../../js/mermaid-init.js"></script>
        <script src="../../js/theme.js"></script>


    </body>
</html>
